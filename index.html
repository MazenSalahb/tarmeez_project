<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="./assets/images/M LogoC.png">
  <!-- Import Boostrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- IMPORT CSS -->
  <link rel="stylesheet" href="./css/main.css" />
  <title>Social Media</title>
</head>

<body>
  <!-- Nav Bar Cont -->
  <div class="container">
    <div class="col-8 mx-auto">
      <nav class="navbar navbar-expand-lg bg-body-tertiary shadow rounded mt-3">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">Mazengo</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">Profile</a>
              </li>
            </ul>

            <div class="d-flex w-100 justify-content-end align-items-center gap-2">
              <!--FOR NON-LOGGED IN USER -->
              <button id="login-btn" type="button" class="btn btn-outline-success" data-bs-toggle="modal"
                data-bs-target="#login-modal">
                Log in
              </button>
              <button id="register-btn" type="button" data-bs-toggle="modal" data-bs-target="#register-modal"
                class="btn btn-outline-success">
                Register
              </button>
              <!-- END FOR NON-LOGGED IN USER -->

              <!-- FOR LOGGED IN USER -->
              <img class="rounded-circle border border-2" alt="porfile picture" id="nav-profile-pic" width="35"
                height="35">
              <span class="text-secondary" id="usName">Mazen</span>

              <button onclick="logout()" id="logout-btn" type="button" class="btn btn-outline-danger">
                Logout
              </button>
              <!-- END FOR LOGGED IN USER -->
            </div>
          </div>
        </div>
      </nav>
    </div>
  </div>

  <!-- MAIN Content -->
  <div class="container">
    <!-- POSTS -->
    <div id="posts" class="col-8 mx-auto mt-5">
      <!-- POST -->
      <!-- <div class="card shadow mb-3">
          <div class="card-header">
            <img
              src="./assets/profile-pics/profile-pic.jpg"
              alt="Profile picture"
              width="40"
              class="rounded-circle border border-3"
            />
            <b>@Mazengo</b>
          </div>
          <div class="card-body">
            <img
              src="./assets/images/clinic bg.jpg"
              alt="clinic"
              width="100%"
            />
            <h6 class="text-secondary mt-1">2 min ago</h6>
            <h5>Hello World!</h5>

            <p>
              Lorem ipsum dolor sit amet, consectetur adipisicing elit. Velit
              eius dolorem, incidunt commodi explicabo illo sint ea nam
              perspiciatis, itaque neque voluptatibus reprehenderit harum
              quaerat numquam fugiat cumque, quia inventore.
            </p>

            <hr />
            <div>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-pen"
                viewBox="0 0 16 16"
              >
                <path
                  d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708l-1.585-1.585z"
                />
              </svg>
              <span> (3) Comments </span>
            </div>
          </div>
        </div> -->
      <!-- ENDPOST -->
    </div>
    <!-- END POSTS -->
  </div>

  <!--================= Add Post Button =================-->
  <div class="bg-primary shadow" id="add-btn" data-bs-toggle="modal" data-bs-target="#create-post-modal">
    +
  </div>
  <!--================= End Add Post Button =================-->

  <!--================= MODALS =================-->
  <!-- Login Modal -->
  <div class="modal fade" id="login-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Login</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="username-input" class="col-form-label">UserName:</label>
              <input type="text" class="form-control" id="username-input" />
            </div>
            <div class="mb-3">
              <label for="message-text" class="col-form-label">Password:</label>
              <input type="password" class="form-control" id="password-input" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
          <button type="button" class="btn btn-primary" onclick="loginBtnClick()">
            Login
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- End Login Modal -->

  <!-- Register Modal -->
  <div class="modal fade" id="register-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Register</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="reg-username-input" class="col-form-label">UserName:</label>
              <input type="text" class="form-control" id="reg-username-input" />
            </div>
            <div class="mb-3">
              <label for="reg-password-text" class="col-form-label">Password:</label>
              <input type="password" class="form-control" id="reg-password-input" />
            </div>
            <div class="mb-3">
              <lab el for="reg-name-text" class="col-form-label">Name:</label>
                <input type="text" class="form-control" id="reg-name-input" />
            </div>
            <div class="mb-3">
              <label for="reg-email-input" class="col-form-label">Email:</label>
              <input type="email" class="form-control" id="reg-email-input" />
            </div>
            <div class="mb-3">
              <label for="reg-image-input" class="col-form-label">Profile Pic:</label>
              <input type="file" class="form-control" id="reg-image-input" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
          <button type="button" class="btn btn-primary" onclick="registerBtnClick()">
            Register
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- End Register Modal -->

  <!-- Create Post Modal -->
  <div class="modal fade" id="create-post-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Create a new post</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="title-input" class="col-form-label">Title:</label>
              <input type="text" class="form-control" id="title-input" />
            </div>
            <div class="mb-3">
              <label for="body-input" class="col-form-label">Body:</label>
              <textarea class="form-control" id="body-input"></textarea>
            </div>
            <div class="mb-3">
              <label for="image-input" class="col-form-label">Image:</label>
              <input type="file" class="form-control" id="image-input" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
          <button type="button" class="btn btn-primary" onclick="createNewPost()">
            Create
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- End Create Post Modal -->
  <!--================= END MODALS =================-->

  <!-- ========== Login Success Toast ========== -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <!-- <img src="..." class="rounded me-2" alt="..."> -->
        <strong class="me-auto">Success</strong>
        <small>just now</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toast-body">Toast Message</div>
    </div>
  </div>
  <!-- End login Toast -->

  <script>
    // ----------------------- API -----------------------
    const baseUrl = "https://tarmeezacademy.com/api/v1";
    // Show Posts
    let page = 1
    getPosts()
    function getPosts() {
      axios.get(`${baseUrl}/posts?limit=5&page=${page}`).then((res) => {
        const posts = res.data.data;

        // document.getElementById("posts").innerHTML = "";
        posts.map((post) => {
          let content = `
            <div class="card shadow mb-3">
          <div class="card-header">
             <img
              src="${typeof post.author.profile_image === "string" ? post.author.profile_image : "./assets/profile-pics/defpic.png"}"
              alt="Profile picture"
              width="40"
              height ="40"
              class="rounded-circle border border-3"
            />
                
            <b>@${post.author.username}</b>
          </div>
          <div class="card-body">
            ${typeof post.image === "string"
              ? `<img
              src="${post.image}"
              alt="clinic"
              width="100%"
            />`
              : ""
            }
            <h6 class="text-secondary mt-1">${post.created_at}</h6>
            <h5>${post.title || ""}</h5>

            <p>
              ${post.body}
            </p>

            <hr />
            <div>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-pen"
                viewBox="0 0 16 16"
              >
                <path
                  d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708l-1.585-1.585z"
                />
              </svg>
              <span> (${post.comments_count}) Comments </span>
            </div>
          </div>
        </div>
        `;
          document.getElementById("posts").innerHTML += content;
        });
      });
      page++
    }

    function createNewPost() {
      const title = document.getElementById("title-input").value;
      const body = document.getElementById("body-input").value;
      const image = document.getElementById("image-input").files[0];
      const token = localStorage.getItem("token")

      let formData = new FormData();
      formData.append("title", title)
      formData.append("body", body)
      formData.append("image", image)

      const headers = {
        "Content-Type": "multipart/form-data",
        "authorization": `Bearer ${token}`
      }
      axios.post(`${baseUrl}/posts`, formData, {
        headers
      })
        .then((res) => {
          bootstrap.Modal.getInstance(
            document.getElementById("create-post-modal")
          ).hide();
          showToast("Poast Added Successfully")
          getPosts()
        }).catch((err) => { alert(err.response.data.message) })
    }

    function showToast(message) {
      document.getElementById("toast-body").innerHTML = message;
      const toastLiveExample = document.getElementById("liveToast");
      const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample);
      toastBootstrap.show();
    }
    // HANDLE PAGI
    // Function to check if user has scrolled to almost the end of the page
    function isNearBottom() {
      const windowHeight = window.innerHeight || document.documentElement.clientHeight;
      const documentHeight = Math.max(
        document.body.scrollHeight,
        document.body.offsetHeight,
        document.documentElement.clientHeight,
        document.documentElement.scrollHeight,
        document.documentElement.offsetHeight
      );

      // The offset to consider as "almost at the end" (you can adjust this value)
      const offset = 500;

      // Check if the user is within the offset from the bottom
      return documentHeight - windowHeight - window.scrollY <= offset;
    }

    // Function to be triggered when the user is almost at the end of the page
    function handleScroll() {
      if (isNearBottom()) {
        // Your code here, e.g., load more content, trigger an action, etc.
        getPosts()

        // Optionally, remove the event listener to avoid multiple triggers
        window.removeEventListener('scroll', handleScroll);
        // Add the event listener back after a certain delay (you can adjust this value)
        setTimeout(function () {
          window.addEventListener('scroll', handleScroll);
        }, 1000);
      }
    }

    // Attach the scroll event listener
    window.addEventListener('scroll', handleScroll);

  </script>

  <!-- Import JS -->
  <script src="./js/main.js"></script>
</body>

</html>